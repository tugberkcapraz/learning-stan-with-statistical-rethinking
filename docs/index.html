<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Learning Stan with Statistical Retinking</title>
  <meta name="description" content="Learning Stan with Statistical Retinking" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Learning Stan with Statistical Retinking" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Learning Stan with Statistical Retinking" />
  
  
  

<meta name="author" content="Kerem Tugberk Capraz" />


<meta name="date" content="2021-07-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  

<link rel="next" href="the-many-variables-the-spurious-waffles.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Work in Progress</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Geocentric Models</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#gaussian-model-of-height"><i class="fa fa-check"></i><b>1.1</b> Gaussian Model of Height</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#using-stan-for-the-first-time"><i class="fa fa-check"></i><b>1.1.1</b> Using Stan for the First Time</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#linear-prediction"><i class="fa fa-check"></i><b>1.2</b> Linear Prediction</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#curves-from-lines"><i class="fa fa-check"></i><b>1.3</b> Curves From Lines</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#linear"><i class="fa fa-check"></i><b>1.3.1</b> Linear</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#quadratic"><i class="fa fa-check"></i><b>1.3.2</b> Quadratic</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#cubic"><i class="fa fa-check"></i><b>1.3.3</b> Cubic</a></li>
<li class="chapter" data-level="1.3.4" data-path="index.html"><a href="index.html#b-splines"><i class="fa fa-check"></i><b>1.3.4</b> B-Splines</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html"><i class="fa fa-check"></i><b>2</b> The Many Variables &amp; The Spurious Waffles</a>
<ul>
<li class="chapter" data-level="2.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#spurious-association"><i class="fa fa-check"></i><b>2.1</b> Spurious Association</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#posterior-prediction-plots"><i class="fa fa-check"></i><b>2.1.1</b> Posterior Prediction Plots</a></li>
<li class="chapter" data-level="2.1.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#counterfactual-plots"><i class="fa fa-check"></i><b>2.1.2</b> Counterfactual Plots</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#masked-relationship"><i class="fa fa-check"></i><b>2.2</b> Masked Relationship</a></li>
<li class="chapter" data-level="2.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#categorical-variables"><i class="fa fa-check"></i><b>2.3</b> Categorical Variables</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#indicator-variables"><i class="fa fa-check"></i><b>2.3.1</b> Indicator Variables</a></li>
<li class="chapter" data-level="2.3.2" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#index-variables"><i class="fa fa-check"></i><b>2.3.2</b> Index Variables</a></li>
<li class="chapter" data-level="2.3.3" data-path="the-many-variables-the-spurious-waffles.html"><a href="the-many-variables-the-spurious-waffles.html#many-variables"><i class="fa fa-check"></i><b>2.3.3</b> Many Variables</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Learning Stan with Statistical Retinking</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">Learning Stan with Statistical Retinking</h1>
<p class="author"><em>Kerem Tugberk Capraz</em></p>
<p class="date" style="margin-top: 1.5em;"><em>2021-07-17</em></p>
</div>
<div id="geocentric-models" class="section level1" number="1">
<h1><span class="header-section-number">Chapter 1</span> Geocentric Models</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="index.html#cb1-1" aria-hidden="true"></a><span class="kw">library</span>(rethinking)</span>
<span id="cb1-2"><a href="index.html#cb1-2" aria-hidden="true"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb1-3"><a href="index.html#cb1-3" aria-hidden="true"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb1-4"><a href="index.html#cb1-4" aria-hidden="true"></a><span class="kw">library</span>(rstan)</span>
<span id="cb1-5"><a href="index.html#cb1-5" aria-hidden="true"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="index.html#cb1-6" aria-hidden="true"></a><span class="kw">library</span>(ggthemes)</span>
<span id="cb1-7"><a href="index.html#cb1-7" aria-hidden="true"></a><span class="kw">library</span>(gridExtra)</span>
<span id="cb1-8"><a href="index.html#cb1-8" aria-hidden="true"></a><span class="kw">library</span>(grid)</span>
<span id="cb1-9"><a href="index.html#cb1-9" aria-hidden="true"></a><span class="kw">library</span>(tidybayes)</span>
<span id="cb1-10"><a href="index.html#cb1-10" aria-hidden="true"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb1-11"><a href="index.html#cb1-11" aria-hidden="true"></a><span class="kw">library</span>(bayesplot)</span>
<span id="cb1-12"><a href="index.html#cb1-12" aria-hidden="true"></a><span class="kw">library</span>(splines) </span>
<span id="cb1-13"><a href="index.html#cb1-13" aria-hidden="true"></a><span class="kw">library</span>(purrr)</span>
<span id="cb1-14"><a href="index.html#cb1-14" aria-hidden="true"></a><span class="kw">library</span>(stringr)</span>
<span id="cb1-15"><a href="index.html#cb1-15" aria-hidden="true"></a><span class="kw">library</span>(brms)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="index.html#cb2-1" aria-hidden="true"></a><span class="kw">data</span>(Howell1)</span>
<span id="cb2-2"><a href="index.html#cb2-2" aria-hidden="true"></a>d &lt;-<span class="st"> </span>Howell1</span>
<span id="cb2-3"><a href="index.html#cb2-3" aria-hidden="true"></a>d2 &lt;-<span class="st"> </span>d[ d<span class="op">$</span>age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">18</span> , ]</span></code></pre></div>
<div id="gaussian-model-of-height" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Gaussian Model of Height</h2>
<p>McElreath’s linear model is as follows:</p>
<p><span class="math display">\[h_i \sim \textrm{Normal} (\mu, \sigma)\\
\ \ \ \ \ \ \mu \sim \textrm{Normal(178, 20)}\\
\ \ \sigma \sim \textrm{Uniform(0,50)}\]</span></p>
<p>Before doing anything let’s visually understand what<br />
<span class="math display">\[\mu \sim \textrm{Normal(178, 20)}\]</span><br />
means</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="index.html#cb3-1" aria-hidden="true"></a><span class="kw">curve</span>(<span class="kw">dnorm</span>(x, <span class="dv">178</span>, <span class="dv">20</span>), <span class="dt">from =</span> <span class="dv">100</span>, <span class="dt">to=</span><span class="dv">250</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-3-1.png" width="100%" />
This is how a normal distribution with mean of 178 and standard deviation of 20 looks like. So we started doing something already.</p>
<p>Now let’s visualise
<span class="math display">\[\sigma \sim \textrm{Uniform(0, 50)}\]</span></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="index.html#cb4-1" aria-hidden="true"></a><span class="kw">curve</span>(<span class="kw">dunif</span>(x, <span class="dv">0</span>, <span class="dv">50</span>), <span class="dt">from=</span><span class="op">-</span><span class="dv">10</span>, <span class="dt">to=</span><span class="dv">60</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-4-1.png" width="100%" /></p>
<p>Everything looks cool so far. Now it’s time to simulate fake height numbers implied by these priors.
What we are going to do is using ‘rnorm’ and ‘runif’ functions with the numbers given us by McElreath.
prior_mu and prior_sigma are the random numbers generated for mu and sigma when we plug the numbers.
prior_height_sim is again using rnorm, but this time rather than setting an arbitrary number for mean and sd parameters inside the rnorm, we are plugging the derived prior_mu and prior_sigma as mean and sd respectively.</p>
<p>then we plot it</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="index.html#cb5-1" aria-hidden="true"></a>prior_mu &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e4</span>, <span class="dv">178</span>, <span class="dv">20</span>)</span>
<span id="cb5-2"><a href="index.html#cb5-2" aria-hidden="true"></a>prior_sigma &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="fl">1e4</span>, <span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb5-3"><a href="index.html#cb5-3" aria-hidden="true"></a>prior_height_sim &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e4</span>, prior_mu, prior_sigma)</span>
<span id="cb5-4"><a href="index.html#cb5-4" aria-hidden="true"></a><span class="kw">dens</span>(prior_height_sim)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-5-1.png" width="100%" /></p>
<p>As you can see the resulting distribution of height is plausible. In order to see what happens under different prior description of the height, we this time tweak the standard deviation of prior mu
<span class="math display">\[\mu \sim \textrm{Normal(178, 100)}\]</span>
Let’s see what happens</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="index.html#cb6-1" aria-hidden="true"></a>prior_mu &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e4</span>, <span class="dv">178</span>, <span class="dv">100</span>)</span>
<span id="cb6-2"><a href="index.html#cb6-2" aria-hidden="true"></a>prior_height_sim &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e4</span>, prior_mu, prior_sigma)</span>
<span id="cb6-3"><a href="index.html#cb6-3" aria-hidden="true"></a><span class="kw">dens</span>(prior_height_sim)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-6-1.png" width="100%" /></p>
<p>Oh my god! This is horrible. Uncertainty is good, however this doesn’t mean that we have to introduce this sort of ridiculous uncertainty into our models. We all know that there are no people around 400 cm tall. Moreover, this distribution also implies that some people have negative heights! Bad prior. Don’t use it.</p>
<p>Now it’s time to use magnificent Stan language for the first time. Fasten your seatbelts.</p>
<p>During the course of these notebooks I will write inline stan codes. I normally don’t do it this way. When working with stan, if you separate your scripts and stan files, then, someone else using <strong>pystan</strong> juliastan etc can easily plug and play with your models in their environments with minimum effort. Plus, it’s also more organized when your stan code is outside of your script.</p>
<div id="using-stan-for-the-first-time" class="section level3" number="1.1.1">
<h3><span class="header-section-number">1.1.1</span> Using Stan for the First Time</h3>
<p>When using stan, at first it may seem daunting that you have to do lot of things manually. I understand and to a degree aggree that this is little bit uncomfortable. However, if you really wish to learn what sort of operations that are taken care of when you are using your ordinary statistics package, then, stan is perhaps the best way. Furthermore, even if you have no appetite for learning what’s happening under the hood when you are fitting models, it’s still essential that you have an idea about what goes beneath the surface. <strong>Every</strong> statistical modelling package or program <strong>make decisions on behalf of you</strong>. You may call them assumptions or whatever it pleases you. When you know about them, you can start modifying them for your purposes.</p>
<p>Stan accepts the data in list format. Whatever you are going to use inside your models must be represented here.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="index.html#cb7-1" aria-hidden="true"></a>stan_data_<span class="dv">4</span>_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> <span class="kw">NROW</span>(d2),</span>
<span id="cb7-2"><a href="index.html#cb7-2" aria-hidden="true"></a>                      <span class="dt">height =</span> d2<span class="op">$</span>height)</span></code></pre></div>
<p>So, we have only two elements in this list. What are they?<br />
<strong>N</strong> is the number of observations. We are telling stan program how many observations that it should expect.The <strong>height</strong> is the vector containing height data.</p>
<p>There two important points here</p>
<p><strong>1)</strong> Naming is up to you. You can call it N or whatever you think it fits. However, once you name it here, you have to stick with that name inside the stan program. Don’t make changes on the fly. And pick names that you can easily remember. This may not seem to be a big issue to you right now. But when the models get complex, then your naming convention will help you. Lets call it <em>clear names principle</em></p>
<p><strong>2)</strong> As you can see, N is just a number. Why didn’t I just pass there the number? It’s related to strategic thinking. In real world applications, unlike these toy examples, the statistical analyses are so rarely linear processes. It doesn’t work in a way that you advance step by step and never return to previous steps. Rather, you try something out. Then you find some discrepancy and you go back to square number one and try different approach (further cleaning, transformation etc.) with your data. So, if you put a constant number there directly, then each time you modified your data you have to make sure that N is still up to date. ‘NROW(d2)’ makes this clear for you. We can call this one <em>don’t hard code principle</em></p>
<pre class="stan"><code>//What this all means is:

//Dear golem,
data{
  int&lt;lower=1&gt; N; // N is number of observations. I gave you this in the data.
  vector[N] height; // Height is a vector containing N observations. This is also
  //in the data
}
parameters{
  real mu; // mu
  real&lt;lower=0, upper=50&gt; sigma; //sigma
  // I&#39;ll give details of them in the next block. Just recognize them for now.
}
model{
  height ~ normal(mu, sigma); //height is normally distributed with mu and sigma
  mu ~ normal(178, 20); //mu is also normally distributed and &quot;I think&quot; mean is 
  //around 178 and since &quot;I think&quot; 138 and 218 are kind of good candidates for
  //being +-2 standard deviations boundary.
  sigma ~ uniform(0,50);
 //sigma is uniformly distributed and can take values between
  // 0 and 50
}
// best regards</code></pre>
<p>So, in the comments part I also tried to outline what’s happening inside the stan model by keeping up with McElreath’s Golem analogy. Let’s move on with fitting it.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="index.html#cb9-1" aria-hidden="true"></a>fit_<span class="dv">4</span>_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">sampling</span>(model_<span class="dv">4</span>_<span class="fl">1.</span>stan, </span>
<span id="cb9-2"><a href="index.html#cb9-2" aria-hidden="true"></a>                    stan_data_<span class="dv">4</span>_<span class="dv">1</span>,</span>
<span id="cb9-3"><a href="index.html#cb9-3" aria-hidden="true"></a>                    <span class="dt">iter=</span><span class="dv">1000</span>,</span>
<span id="cb9-4"><a href="index.html#cb9-4" aria-hidden="true"></a>                    <span class="dt">chains=</span><span class="dv">2</span>,</span>
<span id="cb9-5"><a href="index.html#cb9-5" aria-hidden="true"></a>                    <span class="dt">cores=</span><span class="dv">4</span>)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="index.html#cb10-1" aria-hidden="true"></a><span class="kw">print</span>(fit_<span class="dv">4</span>_<span class="dv">1</span>)</span></code></pre></div>
<pre><code>## Inference for Stan model: 027d8e5b047e6b17c3edb7d22b5b286a.
## 2 chains, each with iter=1000; warmup=500; thin=1; 
## post-warmup draws per chain=500, total post-warmup draws=1000.
## 
##          mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## mu     154.59    0.01 0.41  153.81  154.31  154.59  154.87  155.39   828 1.00
## sigma    7.76    0.01 0.31    7.19    7.55    7.75    7.95    8.40   707 1.00
## lp__  -895.78    0.05 1.08 -898.45 -896.14 -895.45 -895.05 -894.77   497 1.01
## 
## Samples were drawn using NUTS(diag_e) at Sat Jul 17 13:46:38 2021.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>So it was your first model using stan. Congrats!</p>
</div>
</div>
<div id="linear-prediction" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Linear Prediction</h2>
<p>Our next target, following the book is making use of weight variable to predict heights. Before doing so let’s start with plotting them together.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="index.html#cb12-1" aria-hidden="true"></a> <span class="kw">plot</span>( d2<span class="op">$</span>height <span class="op">~</span><span class="st"> </span>d2<span class="op">$</span>weight )</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-11-1.png" width="100%" /></p>
<p>There’s an obvious relationship among those 2. Look how height gets bigger as weight gets bigger.</p>
<p>Let’s write down the model:
<span class="math display">\[h_i \sim \textrm{Normal}(\mu, \sigma) \\
\ \  \mu_i = \alpha + \beta_i(x_i - \bar{x})\\
\ \ \ \ \ \alpha \sim \textrm{Normal}(178, 20) \\
\ \ \beta \sim \textrm{Normal}(0, 10)\\
\ \ \ \sigma \sim \textrm{Uniform}(0,50)\]</span></p>
<p>Notice two things. There’s the new parameter <span class="math inline">\(\beta\)</span>.And this is multiplied by <span class="math inline">\(x_i -\bar{x}\)</span>.
The latter is called centering. So let’s do that.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="index.html#cb13-1" aria-hidden="true"></a>d2<span class="op">$</span>weight_c &lt;-<span class="st"> </span>d2<span class="op">$</span>weight <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(d2<span class="op">$</span>weight)</span></code></pre></div>
<p>And prepare the stan data.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="index.html#cb14-1" aria-hidden="true"></a>stan_data_<span class="dv">4</span>_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> <span class="kw">NROW</span>(d2),</span>
<span id="cb14-2"><a href="index.html#cb14-2" aria-hidden="true"></a>                      <span class="dt">height =</span> d2<span class="op">$</span>height,</span>
<span id="cb14-3"><a href="index.html#cb14-3" aria-hidden="true"></a>                      <span class="dt">weight_c =</span> d2<span class="op">$</span>weight_c)</span></code></pre></div>
<p>But maybe we are going too fast. Let’s talk about prior that we set for <span class="math inline">\(\beta\)</span>. Why did we set this?
More importantly, do we know what does that imply? <span class="math inline">\(\beta\)</span> is telling us about the effect. Is Normal(0,10) a good one? One way to know. Let’s plot it</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="index.html#cb15-1" aria-hidden="true"></a>N &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co"># number of lines</span></span>
<span id="cb15-2"><a href="index.html#cb15-2" aria-hidden="true"></a>a &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dv">178</span>, <span class="dv">20</span>) <span class="co"># alpha</span></span>
<span id="cb15-3"><a href="index.html#cb15-3" aria-hidden="true"></a>b &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">10</span>) <span class="co"># beta</span></span>
<span id="cb15-4"><a href="index.html#cb15-4" aria-hidden="true"></a></span>
<span id="cb15-5"><a href="index.html#cb15-5" aria-hidden="true"></a><span class="co">#plot them</span></span>
<span id="cb15-6"><a href="index.html#cb15-6" aria-hidden="true"></a><span class="kw">plot</span>(<span class="ot">NULL</span>, <span class="dt">xlim=</span><span class="kw">range</span>(d2<span class="op">$</span>weight), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="dv">400</span>), <span class="dt">xlab =</span> <span class="st">&quot;weight&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;height&quot;</span>)</span>
<span id="cb15-7"><a href="index.html#cb15-7" aria-hidden="true"></a><span class="kw">abline</span>( <span class="dt">h=</span><span class="dv">0</span> , <span class="dt">lty=</span><span class="dv">2</span> ) <span class="co"># Embryo</span></span>
<span id="cb15-8"><a href="index.html#cb15-8" aria-hidden="true"></a><span class="kw">abline</span>( <span class="dt">h=</span><span class="dv">272</span> , <span class="dt">lty=</span><span class="dv">1</span> , <span class="dt">lwd=</span><span class="fl">0.5</span> ) <span class="co"># World&#39;s tallest person</span></span>
<span id="cb15-9"><a href="index.html#cb15-9" aria-hidden="true"></a><span class="kw">mtext</span>( <span class="st">&quot;b ~ dnorm(0,10)&quot;</span> )</span>
<span id="cb15-10"><a href="index.html#cb15-10" aria-hidden="true"></a>xbar &lt;-<span class="st"> </span><span class="kw">mean</span>(d2<span class="op">$</span>weight)</span>
<span id="cb15-11"><a href="index.html#cb15-11" aria-hidden="true"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>N ) <span class="kw">curve</span>(a[i] <span class="op">+</span><span class="st"> </span>b[i]<span class="op">*</span>(x<span class="op">-</span>xbar) , </span>
<span id="cb15-12"><a href="index.html#cb15-12" aria-hidden="true"></a>                      <span class="dt">from =</span> <span class="kw">min</span>(d2<span class="op">$</span>weight), <span class="dt">to=</span>d2<span class="op">$</span>height, <span class="dt">add =</span> <span class="ot">TRUE</span>,</span>
<span id="cb15-13"><a href="index.html#cb15-13" aria-hidden="true"></a>                      <span class="dt">col =</span> <span class="kw">col.alpha</span>(<span class="st">&quot;black&quot;</span>, <span class="fl">0.2</span>))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-14-1.png" width="100%" /></p>
<p>This prior implies that there must be some people with negative weights. Also, from it’s standpoint, 30kg to 400cm decreases to -100cm when the weight gets 60. Not plausible at all. Feel free to try different priors. I’ll shoot one</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="index.html#cb16-1" aria-hidden="true"></a>N &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co"># number of lines</span></span>
<span id="cb16-2"><a href="index.html#cb16-2" aria-hidden="true"></a>a &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dv">178</span>, <span class="dv">20</span>) <span class="co"># alpha</span></span>
<span id="cb16-3"><a href="index.html#cb16-3" aria-hidden="true"></a>b &lt;-<span class="st"> </span><span class="kw">rnorm</span>(N, <span class="dv">0</span>, <span class="fl">1.5</span>) <span class="co"># beta</span></span>
<span id="cb16-4"><a href="index.html#cb16-4" aria-hidden="true"></a></span>
<span id="cb16-5"><a href="index.html#cb16-5" aria-hidden="true"></a><span class="co">#plot them</span></span>
<span id="cb16-6"><a href="index.html#cb16-6" aria-hidden="true"></a><span class="kw">plot</span>(<span class="ot">NULL</span>, <span class="dt">xlim=</span><span class="kw">range</span>(d2<span class="op">$</span>weight), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="dv">400</span>), <span class="dt">xlab =</span> <span class="st">&quot;weight&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;height&quot;</span>)</span>
<span id="cb16-7"><a href="index.html#cb16-7" aria-hidden="true"></a><span class="kw">abline</span>( <span class="dt">h=</span><span class="dv">0</span> , <span class="dt">lty=</span><span class="dv">2</span> ) <span class="co"># Embryo</span></span>
<span id="cb16-8"><a href="index.html#cb16-8" aria-hidden="true"></a><span class="kw">abline</span>( <span class="dt">h=</span><span class="dv">272</span> , <span class="dt">lty=</span><span class="dv">1</span> , <span class="dt">lwd=</span><span class="fl">0.5</span> ) <span class="co"># World&#39;s tallest person</span></span>
<span id="cb16-9"><a href="index.html#cb16-9" aria-hidden="true"></a><span class="kw">mtext</span>( <span class="st">&quot;b ~ dnorm(0,1.5)&quot;</span> )</span>
<span id="cb16-10"><a href="index.html#cb16-10" aria-hidden="true"></a>xbar &lt;-<span class="st"> </span><span class="kw">mean</span>(d2<span class="op">$</span>weight)</span>
<span id="cb16-11"><a href="index.html#cb16-11" aria-hidden="true"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>N ) <span class="kw">curve</span>(a[i] <span class="op">+</span><span class="st"> </span>b[i]<span class="op">*</span>(x<span class="op">-</span>xbar) , </span>
<span id="cb16-12"><a href="index.html#cb16-12" aria-hidden="true"></a>                      <span class="dt">from =</span> <span class="kw">min</span>(d2<span class="op">$</span>weight), <span class="dt">to=</span>d2<span class="op">$</span>height, <span class="dt">add =</span> <span class="ot">TRUE</span>,</span>
<span id="cb16-13"><a href="index.html#cb16-13" aria-hidden="true"></a>                      <span class="dt">col =</span> <span class="kw">col.alpha</span>(<span class="st">&quot;black&quot;</span>, <span class="fl">0.2</span>))</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-15-1.png" width="100%" /></p>
<p>Not great, not terrible. Let’s continue with McElreath’s prior.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="index.html#cb17-1" aria-hidden="true"></a>b &lt;-<span class="st"> </span><span class="kw">rlnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>) </span>
<span id="cb17-2"><a href="index.html#cb17-2" aria-hidden="true"></a><span class="co"># plot the chunk above</span></span>
<span id="cb17-3"><a href="index.html#cb17-3" aria-hidden="true"></a><span class="kw">plot</span>(<span class="ot">NULL</span>, <span class="dt">xlim=</span><span class="kw">range</span>(d2<span class="op">$</span>weight) , <span class="dt">ylim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>,<span class="dv">400</span>) , <span class="dt">xlab=</span><span class="st">&quot;weight&quot;</span> , <span class="dt">ylab=</span><span class="st">&quot;height&quot;</span> )</span>
<span id="cb17-4"><a href="index.html#cb17-4" aria-hidden="true"></a><span class="kw">abline</span>( <span class="dt">h=</span><span class="dv">0</span> , <span class="dt">lty=</span><span class="dv">2</span> )</span>
<span id="cb17-5"><a href="index.html#cb17-5" aria-hidden="true"></a><span class="kw">abline</span>( <span class="dt">h=</span><span class="dv">272</span> , <span class="dt">lty=</span><span class="dv">1</span> , <span class="dt">lwd=</span><span class="fl">0.5</span> )</span>
<span id="cb17-6"><a href="index.html#cb17-6" aria-hidden="true"></a><span class="kw">mtext</span>( <span class="st">&quot;b ~ lognorm(0,1)&quot;</span> )</span>
<span id="cb17-7"><a href="index.html#cb17-7" aria-hidden="true"></a>xbar &lt;-<span class="st"> </span><span class="kw">mean</span>(d2<span class="op">$</span>weight)</span>
<span id="cb17-8"><a href="index.html#cb17-8" aria-hidden="true"></a><span class="cf">for</span> ( i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>N ) <span class="kw">curve</span>( a[i] <span class="op">+</span><span class="st"> </span>b[i]<span class="op">*</span>(x <span class="op">-</span><span class="st"> </span>xbar) ,</span>
<span id="cb17-9"><a href="index.html#cb17-9" aria-hidden="true"></a>                        <span class="dt">from=</span><span class="kw">min</span>(d2<span class="op">$</span>weight) , <span class="dt">to=</span><span class="kw">max</span>(d2<span class="op">$</span>weight) , <span class="dt">add=</span><span class="ot">TRUE</span> , <span class="dt">col=</span><span class="kw">col.alpha</span>(<span class="st">&quot;black&quot;</span>,<span class="fl">0.2</span>) )</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-16-1.png" width="100%" /></p>
<pre class="stan"><code>
data {
  int&lt;lower=1&gt; N;
  vector[N] height;
  vector[N] weight_c;
}
parameters {
  real alpha;
  real beta;
  real&lt;lower=0,upper=50&gt; sigma;
}
model {
  vector[N] mu = alpha + beta * weight_c;
  height~ normal(mu, sigma);
  alpha ~ normal(178, 20);
  beta  ~ lognormal(0, 1);
  sigma ~ uniform(0,50);
}
</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="index.html#cb19-1" aria-hidden="true"></a><span class="co"># fit</span></span>
<span id="cb19-2"><a href="index.html#cb19-2" aria-hidden="true"></a>fit_<span class="dv">4</span>_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">sampling</span>(model_<span class="dv">4</span>_<span class="fl">3.</span>stan, <span class="dt">data =</span> stan_data_<span class="dv">4</span>_<span class="dv">3</span>, <span class="dt">iter =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">2</span>, <span class="dt">cores =</span> <span class="dv">2</span>)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="index.html#cb20-1" aria-hidden="true"></a><span class="kw">print</span>(fit_<span class="dv">4</span>_<span class="dv">3</span>, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>))</span></code></pre></div>
<pre><code>## Inference for Stan model: 1b47a5d1ac27ee76501545aa74cbaa76.
## 2 chains, each with iter=1000; warmup=500; thin=1; 
## post-warmup draws per chain=500, total post-warmup draws=1000.
## 
##          mean se_mean   sd     10%     50%     90% n_eff Rhat
## alpha  154.60    0.01 0.27  154.24  154.60  154.95   883    1
## beta     0.90    0.00 0.04    0.85    0.90    0.96  1023    1
## sigma    5.11    0.01 0.19    4.86    5.10    5.37   770    1
## lp__  -748.09    0.06 1.25 -749.90 -747.74 -746.84   485    1
## 
## Samples were drawn using NUTS(diag_e) at Sat Jul 17 13:46:44 2021.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>Plotting the posterior against data</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="index.html#cb22-1" aria-hidden="true"></a>post &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(fit_<span class="dv">4</span>_<span class="dv">3</span>)</span>
<span id="cb22-2"><a href="index.html#cb22-2" aria-hidden="true"></a></span>
<span id="cb22-3"><a href="index.html#cb22-3" aria-hidden="true"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">lims</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">200</span>))</span>
<span id="cb22-4"><a href="index.html#cb22-4" aria-hidden="true"></a>p1 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span></span>
<span id="cb22-5"><a href="index.html#cb22-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d2,</span>
<span id="cb22-6"><a href="index.html#cb22-6" aria-hidden="true"></a>             <span class="kw">aes</span>(weight_c, height), </span>
<span id="cb22-7"><a href="index.html#cb22-7" aria-hidden="true"></a>             <span class="dt">shape =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&#39;dodgerblue&#39;</span>) <span class="op">+</span></span>
<span id="cb22-8"><a href="index.html#cb22-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="kw">mean</span>(post<span class="op">$</span>alpha), <span class="dt">slope =</span> <span class="kw">mean</span>(post<span class="op">$</span>beta)) <span class="op">+</span></span>
<span id="cb22-9"><a href="index.html#cb22-9" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">n.breaks =</span> <span class="dv">3</span>,</span>
<span id="cb22-10"><a href="index.html#cb22-10" aria-hidden="true"></a>                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb22-11"><a href="index.html#cb22-11" aria-hidden="true"></a>                     <span class="dt">labels =</span> <span class="kw">c</span>(<span class="dv">30</span>, <span class="dv">45</span>, <span class="dv">55</span>))</span>
<span id="cb22-12"><a href="index.html#cb22-12" aria-hidden="true"></a>p1</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-20-1.png" width="100%" /></p>
<p>Mean at 50</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="index.html#cb23-1" aria-hidden="true"></a>mu_at_<span class="dv">50</span> &lt;-<span class="st"> </span>post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta<span class="op">*</span><span class="dv">50</span></span>
<span id="cb23-2"><a href="index.html#cb23-2" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="dt">x=</span>mu_at_<span class="dv">50</span>), <span class="dt">color=</span><span class="st">&quot;dodgerblue&quot;</span> ) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;mu | weight = 50&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-21-1.png" width="50%" style="display: block; margin: auto;" />
Wait a minute it’s not possible! What’s happening?</p>
<p>What happens is, we are betraying our own formula. Remember, our formula is calibrated for centered values of weight. If you forget about this and paste the raw weight number there, you’d get this this sort of wrong results.</p>
<p>So if we wish to learn height distribution at weight 50, what we have to do is simply find what centered value of weight that corresponds to raw weight of 50. The way to do is as follows.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="index.html#cb24-1" aria-hidden="true"></a>mu_at_<span class="dv">50</span> &lt;-<span class="st"> </span>post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta<span class="op">*</span>(<span class="dv">50</span> <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(d2<span class="op">$</span>weight))</span>
<span id="cb24-2"><a href="index.html#cb24-2" aria-hidden="true"></a><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="dt">x=</span>mu_at_<span class="dv">50</span>), <span class="dt">color=</span><span class="st">&quot;dodgerblue&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;mu | weight = 50&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-22-1.png" width="50%" style="display: block; margin: auto;" /></p>
<p>Let’s see the density in each weight. When simulating new weights we also have to provide centered version of them. Otherwise,as we saw above, what we get would be far off.</p>
<p>There are plenty of functions that would help you gather draws for the desired parameters from the posterior. At least for the first chapters of this book, I will try to do everything manually writing base R functions. The reason for this is making sure that we understand what’s going on inside the model.</p>
<p>What we are going to do now is, we’ll gather parameters from the posterior and simulate means and predictions manually by putting relevant those parameters from the posterior together in accordance with the formula.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="index.html#cb25-1" aria-hidden="true"></a>f_mu &lt;-<span class="st"> </span><span class="cf">function</span>(x) post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta <span class="op">*</span><span class="st"> </span>x</span>
<span id="cb25-2"><a href="index.html#cb25-2" aria-hidden="true"></a>weight_new &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">25</span>, <span class="dv">70</span>)</span>
<span id="cb25-3"><a href="index.html#cb25-3" aria-hidden="true"></a>weight_new_c &lt;-<span class="st"> </span>weight_new <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(weight_new)</span>
<span id="cb25-4"><a href="index.html#cb25-4" aria-hidden="true"></a></span>
<span id="cb25-5"><a href="index.html#cb25-5" aria-hidden="true"></a>mu &lt;-<span class="st"> </span></span>
<span id="cb25-6"><a href="index.html#cb25-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">sapply</span>(weight_new_c, f_mu) <span class="op">%&gt;%</span></span>
<span id="cb25-7"><a href="index.html#cb25-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb25-8"><a href="index.html#cb25-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_c) <span class="op">%&gt;%</span></span>
<span id="cb25-9"><a href="index.html#cb25-9" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iteration =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb25-10"><a href="index.html#cb25-10" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight, height, <span class="op">-</span>iteration) <span class="op">%&gt;%</span></span>
<span id="cb25-11"><a href="index.html#cb25-11" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight) <span class="op">%&gt;%</span></span>
<span id="cb25-12"><a href="index.html#cb25-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">hpdi_l =</span> HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb25-13"><a href="index.html#cb25-13" aria-hidden="true"></a>         <span class="dt">hpdi_h =</span> HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">2</span>]) <span class="op">%&gt;%</span></span>
<span id="cb25-14"><a href="index.html#cb25-14" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mu =</span> <span class="kw">mean</span>(height)) <span class="op">%&gt;%</span></span>
<span id="cb25-15"><a href="index.html#cb25-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb25-16"><a href="index.html#cb25-16" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight =</span> <span class="kw">as.integer</span>(weight))</span></code></pre></div>
<p>What we did above is writing a function which simulates mu. If we recall the formula<br />
<span class="math display">\[ \mu_i = \alpha + \beta x_i \]</span>
So when we put posterior <span class="math inline">\(\alpha\)</span>s and <span class="math inline">\(\beta\)</span> in this formula, we’ll get posterior <span class="math inline">\(\mu_i\)</span>. The new sequence ‘weight_new_c’ becomes the X. The rest is wrangling the data. Next, we plot it</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="index.html#cb26-1" aria-hidden="true"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>() </span>
<span id="cb26-2"><a href="index.html#cb26-2" aria-hidden="true"></a>p1 &lt;-<span class="st"> </span>p <span class="op">+</span></span>
<span id="cb26-3"><a href="index.html#cb26-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> mu <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(iteration <span class="op">&lt;</span><span class="st"> </span><span class="dv">101</span>),</span>
<span id="cb26-4"><a href="index.html#cb26-4" aria-hidden="true"></a>             <span class="kw">aes</span>(weight, height), <span class="dt">alpha =</span> <span class="fl">.05</span>, <span class="dt">color =</span> <span class="st">&#39;dodgerblue&#39;</span>) <span class="op">+</span></span>
<span id="cb26-5"><a href="index.html#cb26-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle=</span><span class="st">&quot;Density at each weight&quot;</span>) <span class="op">+</span></span>
<span id="cb26-6"><a href="index.html#cb26-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">n.breaks =</span> <span class="dv">5</span>,</span>
<span id="cb26-7"><a href="index.html#cb26-7" aria-hidden="true"></a>                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">20</span>,  <span class="dv">-10</span>, <span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>),</span>
<span id="cb26-8"><a href="index.html#cb26-8" aria-hidden="true"></a>                     <span class="dt">labels =</span> <span class="kw">c</span>( <span class="dv">30</span>,<span class="dv">40</span>, <span class="dv">45</span>, <span class="dv">50</span>, <span class="dv">60</span>))</span>
<span id="cb26-9"><a href="index.html#cb26-9" aria-hidden="true"></a>p2 &lt;-<span class="st"> </span>p <span class="op">+</span></span>
<span id="cb26-10"><a href="index.html#cb26-10" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d2,</span>
<span id="cb26-11"><a href="index.html#cb26-11" aria-hidden="true"></a>             <span class="kw">aes</span>(weight_c, height), <span class="dt">shape =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&#39;dodgerblue&#39;</span>) <span class="op">+</span></span>
<span id="cb26-12"><a href="index.html#cb26-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> mu,</span>
<span id="cb26-13"><a href="index.html#cb26-13" aria-hidden="true"></a>              <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">ymin =</span> hpdi_l, <span class="dt">ymax =</span> hpdi_h),</span>
<span id="cb26-14"><a href="index.html#cb26-14" aria-hidden="true"></a>              <span class="dt">alpha =</span> <span class="fl">.1</span>) <span class="op">+</span></span>
<span id="cb26-15"><a href="index.html#cb26-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">data =</span> post,</span>
<span id="cb26-16"><a href="index.html#cb26-16" aria-hidden="true"></a>              <span class="kw">aes</span>(<span class="dt">intercept =</span> <span class="kw">mean</span>(alpha), <span class="dt">slope =</span> <span class="kw">mean</span>(beta))) <span class="op">+</span></span>
<span id="cb26-17"><a href="index.html#cb26-17" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">n.breaks =</span> <span class="dv">5</span>,</span>
<span id="cb26-18"><a href="index.html#cb26-18" aria-hidden="true"></a>                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">20</span>,  <span class="dv">-10</span>, <span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>),</span>
<span id="cb26-19"><a href="index.html#cb26-19" aria-hidden="true"></a>                     <span class="dt">labels =</span> <span class="kw">c</span>( <span class="dv">30</span>,<span class="dv">40</span>, <span class="dv">45</span>, <span class="dv">50</span>, <span class="dv">60</span>)) <span class="op">+</span></span>
<span id="cb26-20"><a href="index.html#cb26-20" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle=</span><span class="st">&quot;HPDI Interval = 0.95&quot;</span>)</span>
<span id="cb26-21"><a href="index.html#cb26-21" aria-hidden="true"></a><span class="kw">grid.arrange</span>(p1, p2, <span class="dt">nrow =</span> <span class="dv">1</span>)  </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-24-1.png" width="100%" /></p>
<p>Now we are continuing with prediction invervals.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="index.html#cb27-1" aria-hidden="true"></a>sim_ht &lt;-<span class="st"> </span></span>
<span id="cb27-2"><a href="index.html#cb27-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">sapply</span>(weight_new_c,<span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="kw">NROW</span>(post),</span>
<span id="cb27-3"><a href="index.html#cb27-3" aria-hidden="true"></a>                                      post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta <span class="op">*</span><span class="st"> </span>x,</span>
<span id="cb27-4"><a href="index.html#cb27-4" aria-hidden="true"></a>                                      post<span class="op">$</span>sigma)) <span class="op">%&gt;%</span></span>
<span id="cb27-5"><a href="index.html#cb27-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb27-6"><a href="index.html#cb27-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_c)<span class="op">%&gt;%</span></span>
<span id="cb27-7"><a href="index.html#cb27-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iteration =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb27-8"><a href="index.html#cb27-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight, height, <span class="op">-</span>iteration) <span class="op">%&gt;%</span></span>
<span id="cb27-9"><a href="index.html#cb27-9" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight) <span class="op">%&gt;%</span></span>
<span id="cb27-10"><a href="index.html#cb27-10" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pi_l =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob =</span> <span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb27-11"><a href="index.html#cb27-11" aria-hidden="true"></a>         <span class="dt">pi_h =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob =</span> <span class="fl">0.8</span>)[<span class="dv">2</span>]) <span class="op">%&gt;%</span></span>
<span id="cb27-12"><a href="index.html#cb27-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb27-13"><a href="index.html#cb27-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight =</span> <span class="kw">as.integer</span>(weight))</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="index.html#cb28-1" aria-hidden="true"></a>p2 <span class="op">+</span><span class="st"> </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> sim_ht,</span>
<span id="cb28-2"><a href="index.html#cb28-2" aria-hidden="true"></a>                 <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x=</span>weight, <span class="dt">ymin=</span>pi_l, <span class="dt">ymax=</span>pi_h), <span class="dt">alpha =</span> <span class="fl">.3</span>) <span class="op">+</span></span>
<span id="cb28-3"><a href="index.html#cb28-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&#39;Prediction Intervals = 0.95&#39;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>Yes, too much work but but this was necessary</p>
<p>So far, we did:</p>
<pre><code>- blueprinting for the golem when we spend time on visualising priors
- then we engineered the golem using stan according to that blueprint
- lastly, we reverse-engineered the golem to access the outputs(posterior)</code></pre>
<p>I know there are lot’s of packages that automates each of these processes. But if you can’t do these
steps without the aid of any external package, then, I am sorry to tell you that you can’t debug your golem properly.</p>
</div>
<div id="curves-from-lines" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Curves From Lines</h2>
<p>In this part we are going to build three models. First one is the linear one which we already know how to do. Second will be quadratic model. And, third will be the cubic model. For each of them, we are after the model fit, we are going to do reverse engineering for accessing the posterior distribution of the <span class="math inline">\(\mu\)</span> manually. Lastly, we are going to combine all three in a plot to show differences.</p>
<div id="linear" class="section level3" number="1.3.1">
<h3><span class="header-section-number">1.3.1</span> Linear</h3>
<p>It’s the same linear model. We are fitting it for the comparison plot.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="index.html#cb30-1" aria-hidden="true"></a>d<span class="op">$</span>weight_z &lt;-<span class="st"> </span>(d<span class="op">$</span>weight <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(d<span class="op">$</span>weight)) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(d<span class="op">$</span>weight)</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="index.html#cb31-1" aria-hidden="true"></a>stan_data_polynomial_sq &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span> <span class="kw">NROW</span>(d),</span>
<span id="cb31-2"><a href="index.html#cb31-2" aria-hidden="true"></a>           <span class="dt">height =</span> d<span class="op">$</span>height,</span>
<span id="cb31-3"><a href="index.html#cb31-3" aria-hidden="true"></a>           <span class="dt">weight_z =</span> d<span class="op">$</span>weight_z</span>
<span id="cb31-4"><a href="index.html#cb31-4" aria-hidden="true"></a>           )</span></code></pre></div>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] height;
  vector[N] weight_z;
}
parameters {
  real alpha;
  real beta_1;
  real&lt;lower=0, upper=50&gt; sigma;
}
model {
  vector[N] mu = alpha + beta_1 * weight_z;
  height ~ normal(mu, sigma);
  alpha ~ normal(178, 20 );
  beta_1 ~lognormal( 0, 1);
}
</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="index.html#cb33-1" aria-hidden="true"></a>fit_linear &lt;-<span class="st"> </span><span class="kw">sampling</span>(model_linear.stan,</span>
<span id="cb33-2"><a href="index.html#cb33-2" aria-hidden="true"></a>                              <span class="dt">data =</span> stan_data_polynomial_sq,</span>
<span id="cb33-3"><a href="index.html#cb33-3" aria-hidden="true"></a>                              <span class="dt">chain=</span><span class="dv">2</span>,</span>
<span id="cb33-4"><a href="index.html#cb33-4" aria-hidden="true"></a>                              <span class="dt">iter=</span><span class="dv">1000</span>,</span>
<span id="cb33-5"><a href="index.html#cb33-5" aria-hidden="true"></a>                              <span class="dt">cores=</span><span class="dv">4</span>)</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="index.html#cb34-1" aria-hidden="true"></a><span class="kw">print</span>(fit_linear)</span></code></pre></div>
<pre><code>## Inference for Stan model: 0cc64dd7e305ca8b769e2cac7faa3a75.
## 2 chains, each with iter=1000; warmup=500; thin=1; 
## post-warmup draws per chain=500, total post-warmup draws=1000.
## 
##            mean se_mean   sd     2.5%      25%      50%      75%    97.5% n_eff Rhat
## alpha    138.27    0.01 0.40   137.50   137.98   138.26   138.54   139.00  1004    1
## beta_1    25.94    0.01 0.39    25.16    25.69    25.95    26.18    26.77  1163    1
## sigma      9.41    0.01 0.31     8.84     9.20     9.39     9.61    10.05   966    1
## lp__   -1497.85    0.06 1.34 -1501.58 -1498.44 -1497.47 -1496.90 -1496.43   524    1
## 
## Samples were drawn using NUTS(diag_e) at Sat Jul 17 13:46:53 2021.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="index.html#cb36-1" aria-hidden="true"></a>post &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(fit_linear)</span>
<span id="cb36-2"><a href="index.html#cb36-2" aria-hidden="true"></a>weight_new_z &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="fl">2.2</span>, <span class="dv">2</span>, <span class="dt">length.out =</span> <span class="dv">30</span>)</span>
<span id="cb36-3"><a href="index.html#cb36-3" aria-hidden="true"></a></span>
<span id="cb36-4"><a href="index.html#cb36-4" aria-hidden="true"></a>sim_mu_linear &lt;-<span class="st"> </span><span class="cf">function</span>(x) post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x </span>
<span id="cb36-5"><a href="index.html#cb36-5" aria-hidden="true"></a>sim_prediction_linear &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="kw">NROW</span>(post),</span>
<span id="cb36-6"><a href="index.html#cb36-6" aria-hidden="true"></a>                                    <span class="dt">mean =</span> <span class="kw">sim_mu_linear</span>(x),</span>
<span id="cb36-7"><a href="index.html#cb36-7" aria-hidden="true"></a>                                    <span class="dt">sd =</span> post<span class="op">$</span>sigma)</span>
<span id="cb36-8"><a href="index.html#cb36-8" aria-hidden="true"></a></span>
<span id="cb36-9"><a href="index.html#cb36-9" aria-hidden="true"></a></span>
<span id="cb36-10"><a href="index.html#cb36-10" aria-hidden="true"></a></span>
<span id="cb36-11"><a href="index.html#cb36-11" aria-hidden="true"></a>simulated_mu_linear &lt;-<span class="st"> </span><span class="kw">sapply</span>(weight_new_z, sim_mu_linear)<span class="op">%&gt;%</span></span>
<span id="cb36-12"><a href="index.html#cb36-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb36-13"><a href="index.html#cb36-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb36-14"><a href="index.html#cb36-14" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Iter =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb36-15"><a href="index.html#cb36-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight_new_z, height, <span class="op">-</span>Iter) <span class="op">%&gt;%</span></span>
<span id="cb36-16"><a href="index.html#cb36-16" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb36-17"><a href="index.html#cb36-17" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb36-18"><a href="index.html#cb36-18" aria-hidden="true"></a>    <span class="dt">hpdi_low  =</span> HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb36-19"><a href="index.html#cb36-19" aria-hidden="true"></a>    <span class="dt">hpdi_high =</span>  HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">2</span>],</span>
<span id="cb36-20"><a href="index.html#cb36-20" aria-hidden="true"></a>    <span class="dt">mu =</span> <span class="kw">mean</span>(height)</span>
<span id="cb36-21"><a href="index.html#cb36-21" aria-hidden="true"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb36-22"><a href="index.html#cb36-22" aria-hidden="true"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb36-23"><a href="index.html#cb36-23" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight_new_z =</span>  <span class="kw">as.numeric</span>(weight_new_z))</span>
<span id="cb36-24"><a href="index.html#cb36-24" aria-hidden="true"></a></span>
<span id="cb36-25"><a href="index.html#cb36-25" aria-hidden="true"></a><span class="co">#########</span></span>
<span id="cb36-26"><a href="index.html#cb36-26" aria-hidden="true"></a>simulated_predictions_linear &lt;-<span class="st"> </span><span class="kw">sapply</span>(weight_new_z, sim_prediction_linear)<span class="op">%&gt;%</span></span>
<span id="cb36-27"><a href="index.html#cb36-27" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb36-28"><a href="index.html#cb36-28" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb36-29"><a href="index.html#cb36-29" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Iter  =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb36-30"><a href="index.html#cb36-30" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight_new_z, height, <span class="op">-</span>Iter) <span class="op">%&gt;%</span></span>
<span id="cb36-31"><a href="index.html#cb36-31" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb36-32"><a href="index.html#cb36-32" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb36-33"><a href="index.html#cb36-33" aria-hidden="true"></a>    <span class="dt">pi_low  =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob=</span><span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb36-34"><a href="index.html#cb36-34" aria-hidden="true"></a>    <span class="dt">pi_high =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob=</span><span class="fl">0.8</span>)[<span class="dv">2</span>],</span>
<span id="cb36-35"><a href="index.html#cb36-35" aria-hidden="true"></a>    <span class="dt">mu =</span> <span class="kw">mean</span>(height)</span>
<span id="cb36-36"><a href="index.html#cb36-36" aria-hidden="true"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-37"><a href="index.html#cb36-37" aria-hidden="true"></a><span class="st">  </span><span class="kw">ungroup</span>()<span class="op">%&gt;%</span></span>
<span id="cb36-38"><a href="index.html#cb36-38" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight_new_z =</span> <span class="kw">as.numeric</span>(weight_new_z))</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="index.html#cb37-1" aria-hidden="true"></a>p_linear &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb37-2"><a href="index.html#cb37-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d,</span>
<span id="cb37-3"><a href="index.html#cb37-3" aria-hidden="true"></a>             <span class="kw">aes</span>(weight_z, height), <span class="dt">shape =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&#39;dodgerblue&#39;</span>) <span class="op">+</span></span>
<span id="cb37-4"><a href="index.html#cb37-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> simulated_predictions_linear,</span>
<span id="cb37-5"><a href="index.html#cb37-5" aria-hidden="true"></a>              <span class="kw">aes</span>(<span class="dt">x =</span> weight_new_z, <span class="dt">ymin =</span> pi_low, <span class="dt">ymax =</span> pi_high), <span class="dt">alpha =</span> <span class="fl">.1</span>) <span class="op">+</span></span>
<span id="cb37-6"><a href="index.html#cb37-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> simulated_mu_linear,</span>
<span id="cb37-7"><a href="index.html#cb37-7" aria-hidden="true"></a>            <span class="kw">aes</span>(weight_new_z, mu)) <span class="op">+</span></span>
<span id="cb37-8"><a href="index.html#cb37-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&#39;weight&#39;</span>)</span></code></pre></div>
</div>
<div id="quadratic" class="section level3" number="1.3.2">
<h3><span class="header-section-number">1.3.2</span> Quadratic</h3>
<p>Now the quadratic model which is mathematically written as</p>
<p><span class="math display">\[\ h_i \sim \mathrm{Normal}(\mu_i , \sigma ) \\
 \ \ \ \ \ \ \ \ \mu_i = \alpha + \beta_1 X_i + \beta_2 X^2_i \\
 \ \ \  \ \ \alpha \sim \mathrm{Normal(178, 20)} \\
 \ \ \ \ \ \ \ \ \ \ \ \ \beta_1 \sim \mathrm{Log-Normal(0, 1)} \\
\ \beta_2 \sim \mathrm{Normal(0, 1)} \\
\ \ \ \sigma \sim \mathrm{Uniform(0, 50)} \\\]</span></p>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] height;
  vector[N] weight_z;
}
parameters {
  real alpha;
  real beta_1;
  real beta_2;
  real&lt;lower=0, upper=50&gt; sigma;
}
model {
  vector[N] mu = alpha + beta_1 * weight_z + beta_2 * (weight_z .* weight_z);
  height ~ normal(mu, sigma);
  alpha ~ normal(178, 20 );
  beta_1 ~  lognormal( 0, 1);
  beta_2 ~  normal(0, 1);
}</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="index.html#cb39-1" aria-hidden="true"></a>fit_polynomial_quad &lt;-<span class="st"> </span><span class="kw">sampling</span>(model_polynomial_quad.stan,</span>
<span id="cb39-2"><a href="index.html#cb39-2" aria-hidden="true"></a>                              <span class="dt">data =</span> stan_data_polynomial_sq,</span>
<span id="cb39-3"><a href="index.html#cb39-3" aria-hidden="true"></a>                              <span class="dt">chain=</span><span class="dv">2</span>,</span>
<span id="cb39-4"><a href="index.html#cb39-4" aria-hidden="true"></a>                              <span class="dt">iter=</span><span class="dv">1000</span>,</span>
<span id="cb39-5"><a href="index.html#cb39-5" aria-hidden="true"></a>                              <span class="dt">cores=</span><span class="dv">4</span>)</span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="index.html#cb40-1" aria-hidden="true"></a><span class="kw">print</span>(fit_polynomial_quad)</span></code></pre></div>
<pre><code>## Inference for Stan model: c8283f3bc71ce1c902fd867c77383633.
## 2 chains, each with iter=1000; warmup=500; thin=1; 
## post-warmup draws per chain=500, total post-warmup draws=1000.
## 
##            mean se_mean   sd     2.5%      25%      50%      75%    97.5% n_eff Rhat
## alpha    146.05    0.02 0.37   145.36   145.79   146.01   146.29   146.79   465 1.00
## beta_1    21.73    0.01 0.30    21.17    21.52    21.71    21.94    22.34   743 1.00
## beta_2    -7.80    0.01 0.28    -8.34    -8.00    -7.80    -7.60    -7.28   454 1.00
## sigma      5.80    0.01 0.19     5.43     5.67     5.79     5.92     6.16   726 1.00
## lp__   -1265.87    0.07 1.38 -1269.32 -1266.66 -1265.55 -1264.83 -1264.07   414 1.01
## 
## Samples were drawn using NUTS(diag_e) at Sat Jul 17 13:46:59 2021.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="index.html#cb42-1" aria-hidden="true"></a>post &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(fit_polynomial_quad)</span>
<span id="cb42-2"><a href="index.html#cb42-2" aria-hidden="true"></a>weight_new_z &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="fl">2.2</span>, <span class="dv">2</span>, <span class="dt">length.out =</span> <span class="dv">30</span>)</span>
<span id="cb42-3"><a href="index.html#cb42-3" aria-hidden="true"></a></span>
<span id="cb42-4"><a href="index.html#cb42-4" aria-hidden="true"></a>sim_mu_quad &lt;-<span class="st"> </span><span class="cf">function</span>(x) post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(x<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb42-5"><a href="index.html#cb42-5" aria-hidden="true"></a>sim_prediction_quad &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="kw">NROW</span>(post),</span>
<span id="cb42-6"><a href="index.html#cb42-6" aria-hidden="true"></a>                                    <span class="dt">mean =</span> post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(x<span class="op">^</span><span class="dv">2</span>),</span>
<span id="cb42-7"><a href="index.html#cb42-7" aria-hidden="true"></a>                                    <span class="dt">sd =</span> post<span class="op">$</span>sigma)</span>
<span id="cb42-8"><a href="index.html#cb42-8" aria-hidden="true"></a></span>
<span id="cb42-9"><a href="index.html#cb42-9" aria-hidden="true"></a></span>
<span id="cb42-10"><a href="index.html#cb42-10" aria-hidden="true"></a></span>
<span id="cb42-11"><a href="index.html#cb42-11" aria-hidden="true"></a>simulated_mu &lt;-<span class="st"> </span><span class="kw">sapply</span>(weight_new_z, sim_mu_quad)<span class="op">%&gt;%</span></span>
<span id="cb42-12"><a href="index.html#cb42-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb42-13"><a href="index.html#cb42-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb42-14"><a href="index.html#cb42-14" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Iter =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb42-15"><a href="index.html#cb42-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight_new_z, height, <span class="op">-</span>Iter) <span class="op">%&gt;%</span></span>
<span id="cb42-16"><a href="index.html#cb42-16" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb42-17"><a href="index.html#cb42-17" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb42-18"><a href="index.html#cb42-18" aria-hidden="true"></a>    <span class="dt">hpdi_low  =</span> HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb42-19"><a href="index.html#cb42-19" aria-hidden="true"></a>    <span class="dt">hpdi_high =</span>  HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">2</span>],</span>
<span id="cb42-20"><a href="index.html#cb42-20" aria-hidden="true"></a>    <span class="dt">mu =</span> <span class="kw">mean</span>(height)</span>
<span id="cb42-21"><a href="index.html#cb42-21" aria-hidden="true"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb42-22"><a href="index.html#cb42-22" aria-hidden="true"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb42-23"><a href="index.html#cb42-23" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight_new_z =</span>  <span class="kw">as.numeric</span>(weight_new_z))</span>
<span id="cb42-24"><a href="index.html#cb42-24" aria-hidden="true"></a></span>
<span id="cb42-25"><a href="index.html#cb42-25" aria-hidden="true"></a><span class="co">#########</span></span>
<span id="cb42-26"><a href="index.html#cb42-26" aria-hidden="true"></a>simulated_predictions &lt;-<span class="st"> </span><span class="kw">sapply</span>(weight_new_z, sim_prediction_quad)<span class="op">%&gt;%</span></span>
<span id="cb42-27"><a href="index.html#cb42-27" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb42-28"><a href="index.html#cb42-28" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb42-29"><a href="index.html#cb42-29" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Iter  =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb42-30"><a href="index.html#cb42-30" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight_new_z, height, <span class="op">-</span>Iter) <span class="op">%&gt;%</span></span>
<span id="cb42-31"><a href="index.html#cb42-31" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb42-32"><a href="index.html#cb42-32" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb42-33"><a href="index.html#cb42-33" aria-hidden="true"></a>    <span class="dt">pi_low  =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob=</span><span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb42-34"><a href="index.html#cb42-34" aria-hidden="true"></a>    <span class="dt">pi_high =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob=</span><span class="fl">0.8</span>)[<span class="dv">2</span>],</span>
<span id="cb42-35"><a href="index.html#cb42-35" aria-hidden="true"></a>    <span class="dt">mu =</span> <span class="kw">mean</span>(height)</span>
<span id="cb42-36"><a href="index.html#cb42-36" aria-hidden="true"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb42-37"><a href="index.html#cb42-37" aria-hidden="true"></a><span class="st">  </span><span class="kw">ungroup</span>()<span class="op">%&gt;%</span></span>
<span id="cb42-38"><a href="index.html#cb42-38" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight_new_z =</span> <span class="kw">as.numeric</span>(weight_new_z))</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="index.html#cb43-1" aria-hidden="true"></a>p_quad &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb43-2"><a href="index.html#cb43-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d,</span>
<span id="cb43-3"><a href="index.html#cb43-3" aria-hidden="true"></a>             <span class="kw">aes</span>(weight_z, height), <span class="dt">shape =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&#39;dodgerblue&#39;</span>) <span class="op">+</span></span>
<span id="cb43-4"><a href="index.html#cb43-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> simulated_predictions,</span>
<span id="cb43-5"><a href="index.html#cb43-5" aria-hidden="true"></a>              <span class="kw">aes</span>(<span class="dt">x =</span> weight_new_z, <span class="dt">ymin =</span> pi_low, <span class="dt">ymax =</span> pi_high), <span class="dt">alpha =</span> <span class="fl">.1</span>) <span class="op">+</span></span>
<span id="cb43-6"><a href="index.html#cb43-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> simulated_mu,</span>
<span id="cb43-7"><a href="index.html#cb43-7" aria-hidden="true"></a>            <span class="kw">aes</span>(weight_new_z, mu)) <span class="op">+</span></span>
<span id="cb43-8"><a href="index.html#cb43-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&#39;weight&#39;</span>)</span></code></pre></div>
</div>
<div id="cubic" class="section level3" number="1.3.3">
<h3><span class="header-section-number">1.3.3</span> Cubic</h3>
<p>Now let’s fit a cubic model
Now the quadratic model which is mathematically written as</p>
<p><span class="math display">\[\ h_i \sim \mathrm{Normal}(\mu_i , \sigma ) \\
 \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mu_i = \alpha + \beta_1 X_i + \beta_2 X^2_i + \beta_3 X^3_i \\
 \ \ \  \ \ \alpha \sim \mathrm{Normal(178, 20)} \\
 \ \ \ \ \ \ \ \ \ \ \ \ \beta_1 \sim \mathrm{Log-Normal(0, 1)} \\
\ \beta_2 \sim \mathrm{Normal(0, 1)} \\
\ \beta_3 \sim \mathrm{Normal(0, 1)} \\
\ \ \ \sigma \sim \mathrm{Uniform(0, 50)}\]</span></p>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; N;
  vector[N] height;
  vector[N] weight_z;
}
parameters {
  real alpha;
  real beta_1;
  real beta_2;
  real beta_3;
  real&lt;lower=0, upper=50&gt; sigma;
}
model {
  vector[N] mu = alpha + beta_1 * weight_z + beta_2 * (weight_z .* weight_z) +
   beta_3 * (weight_z .* weight_z .* weight_z);
  height ~ normal(mu, sigma);
  alpha ~ normal(178, 20 );
  beta_1 ~  lognormal( 0, 1);
  beta_2 ~  normal(0, 1);
  beta_3 ~ normal(0, 1);
}
</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="index.html#cb45-1" aria-hidden="true"></a>fit_polynomial_cubic &lt;-<span class="st"> </span><span class="kw">sampling</span>(model_polynomial_cubic.stan,</span>
<span id="cb45-2"><a href="index.html#cb45-2" aria-hidden="true"></a>                              <span class="dt">data =</span> stan_data_polynomial_sq,</span>
<span id="cb45-3"><a href="index.html#cb45-3" aria-hidden="true"></a>                              <span class="dt">chain=</span><span class="dv">2</span>,</span>
<span id="cb45-4"><a href="index.html#cb45-4" aria-hidden="true"></a>                              <span class="dt">iter=</span><span class="dv">1000</span>,</span>
<span id="cb45-5"><a href="index.html#cb45-5" aria-hidden="true"></a>                              <span class="dt">cores=</span><span class="dv">4</span>)</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="index.html#cb46-1" aria-hidden="true"></a><span class="kw">print</span>(fit_polynomial_cubic)</span></code></pre></div>
<pre><code>## Inference for Stan model: 65abd3a39add4d74f190faa19f781c83.
## 2 chains, each with iter=1000; warmup=500; thin=1; 
## post-warmup draws per chain=500, total post-warmup draws=1000.
## 
##            mean se_mean   sd     2.5%      25%      50%      75%    97.5% n_eff Rhat
## alpha    146.40    0.01 0.32   145.77   146.17   146.39   146.61   147.02   625 1.00
## beta_1    15.24    0.02 0.45    14.38    14.92    15.24    15.56    16.11   583 1.00
## beta_2    -6.21    0.01 0.26    -6.70    -6.40    -6.21    -6.03    -5.73   612 1.00
## beta_3     3.58    0.01 0.22     3.12     3.43     3.57     3.72     4.00   571 1.00
## sigma      4.87    0.01 0.16     4.57     4.75     4.86     4.98     5.17   674 1.01
## lp__   -1163.14    0.07 1.56 -1167.01 -1164.04 -1162.85 -1161.98 -1160.96   529 1.00
## 
## Samples were drawn using NUTS(diag_e) at Sat Jul 17 13:47:05 2021.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="index.html#cb48-1" aria-hidden="true"></a>post &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(fit_polynomial_cubic)</span>
<span id="cb48-2"><a href="index.html#cb48-2" aria-hidden="true"></a>weight_new_z &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="fl">2.2</span>, <span class="dv">2</span>, <span class="dt">length.out =</span> <span class="dv">30</span>)</span>
<span id="cb48-3"><a href="index.html#cb48-3" aria-hidden="true"></a></span>
<span id="cb48-4"><a href="index.html#cb48-4" aria-hidden="true"></a>sim_mu_cubic &lt;-<span class="st"> </span><span class="cf">function</span>(x) post<span class="op">$</span>alpha <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta_<span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>post<span class="op">$</span>beta_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(x<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb48-5"><a href="index.html#cb48-5" aria-hidden="true"></a><span class="st">  </span>post<span class="op">$</span>beta_<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>(x<span class="op">^</span><span class="dv">3</span>)</span>
<span id="cb48-6"><a href="index.html#cb48-6" aria-hidden="true"></a>sim_prediction_cubic &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="kw">NROW</span>(post),</span>
<span id="cb48-7"><a href="index.html#cb48-7" aria-hidden="true"></a>                                    <span class="dt">mean =</span> <span class="kw">sim_mu_cubic</span>(x),</span>
<span id="cb48-8"><a href="index.html#cb48-8" aria-hidden="true"></a>                                    <span class="dt">sd =</span> post<span class="op">$</span>sigma)</span>
<span id="cb48-9"><a href="index.html#cb48-9" aria-hidden="true"></a></span>
<span id="cb48-10"><a href="index.html#cb48-10" aria-hidden="true"></a></span>
<span id="cb48-11"><a href="index.html#cb48-11" aria-hidden="true"></a></span>
<span id="cb48-12"><a href="index.html#cb48-12" aria-hidden="true"></a>simulated_mu_cubic &lt;-<span class="st"> </span><span class="kw">sapply</span>(weight_new_z, sim_mu_cubic)<span class="op">%&gt;%</span></span>
<span id="cb48-13"><a href="index.html#cb48-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb48-14"><a href="index.html#cb48-14" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb48-15"><a href="index.html#cb48-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Iter =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb48-16"><a href="index.html#cb48-16" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight_new_z, height, <span class="op">-</span>Iter) <span class="op">%&gt;%</span></span>
<span id="cb48-17"><a href="index.html#cb48-17" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb48-18"><a href="index.html#cb48-18" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb48-19"><a href="index.html#cb48-19" aria-hidden="true"></a>    <span class="dt">hpdi_low  =</span> HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb48-20"><a href="index.html#cb48-20" aria-hidden="true"></a>    <span class="dt">hpdi_high =</span>  HDInterval<span class="op">::</span><span class="kw">hdi</span>(height, <span class="dt">credMass =</span> <span class="fl">0.8</span>)[<span class="dv">2</span>],</span>
<span id="cb48-21"><a href="index.html#cb48-21" aria-hidden="true"></a>    <span class="dt">mu =</span> <span class="kw">mean</span>(height)</span>
<span id="cb48-22"><a href="index.html#cb48-22" aria-hidden="true"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb48-23"><a href="index.html#cb48-23" aria-hidden="true"></a><span class="st">  </span>ungroup <span class="op">%&gt;%</span></span>
<span id="cb48-24"><a href="index.html#cb48-24" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight_new_z =</span>  <span class="kw">as.numeric</span>(weight_new_z))</span>
<span id="cb48-25"><a href="index.html#cb48-25" aria-hidden="true"></a></span>
<span id="cb48-26"><a href="index.html#cb48-26" aria-hidden="true"></a><span class="co">#########</span></span>
<span id="cb48-27"><a href="index.html#cb48-27" aria-hidden="true"></a>simulated_predictions_cubic &lt;-<span class="st"> </span><span class="kw">sapply</span>(weight_new_z, sim_prediction_cubic)<span class="op">%&gt;%</span></span>
<span id="cb48-28"><a href="index.html#cb48-28" aria-hidden="true"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></span>
<span id="cb48-29"><a href="index.html#cb48-29" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename_all</span>(<span class="cf">function</span>(x) weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb48-30"><a href="index.html#cb48-30" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Iter  =</span> <span class="kw">row_number</span>()) <span class="op">%&gt;%</span></span>
<span id="cb48-31"><a href="index.html#cb48-31" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather</span>(weight_new_z, height, <span class="op">-</span>Iter) <span class="op">%&gt;%</span></span>
<span id="cb48-32"><a href="index.html#cb48-32" aria-hidden="true"></a><span class="st">  </span><span class="kw">group_by</span>(weight_new_z) <span class="op">%&gt;%</span></span>
<span id="cb48-33"><a href="index.html#cb48-33" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb48-34"><a href="index.html#cb48-34" aria-hidden="true"></a>    <span class="dt">pi_low  =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob=</span><span class="fl">0.8</span>)[<span class="dv">1</span>],</span>
<span id="cb48-35"><a href="index.html#cb48-35" aria-hidden="true"></a>    <span class="dt">pi_high =</span> rethinking<span class="op">::</span><span class="kw">PI</span>(height, <span class="dt">prob=</span><span class="fl">0.8</span>)[<span class="dv">2</span>],</span>
<span id="cb48-36"><a href="index.html#cb48-36" aria-hidden="true"></a>    <span class="dt">mu =</span> <span class="kw">mean</span>(height)</span>
<span id="cb48-37"><a href="index.html#cb48-37" aria-hidden="true"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-38"><a href="index.html#cb48-38" aria-hidden="true"></a><span class="st">  </span><span class="kw">ungroup</span>()<span class="op">%&gt;%</span></span>
<span id="cb48-39"><a href="index.html#cb48-39" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weight_new_z =</span> <span class="kw">as.numeric</span>(weight_new_z))</span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="index.html#cb49-1" aria-hidden="true"></a>p_cubic &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb49-2"><a href="index.html#cb49-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d,</span>
<span id="cb49-3"><a href="index.html#cb49-3" aria-hidden="true"></a>             <span class="kw">aes</span>(weight_z, height), <span class="dt">shape =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&#39;dodgerblue&#39;</span>) <span class="op">+</span></span>
<span id="cb49-4"><a href="index.html#cb49-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">data =</span> simulated_predictions_cubic,</span>
<span id="cb49-5"><a href="index.html#cb49-5" aria-hidden="true"></a>              <span class="kw">aes</span>(<span class="dt">x =</span> weight_new_z, <span class="dt">ymin =</span> pi_low, <span class="dt">ymax =</span> pi_high), <span class="dt">alpha =</span> <span class="fl">.1</span>) <span class="op">+</span></span>
<span id="cb49-6"><a href="index.html#cb49-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> simulated_mu_cubic,</span>
<span id="cb49-7"><a href="index.html#cb49-7" aria-hidden="true"></a>            <span class="kw">aes</span>(weight_new_z, mu)) <span class="op">+</span></span>
<span id="cb49-8"><a href="index.html#cb49-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&#39;weight&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="index.html#cb50-1" aria-hidden="true"></a><span class="kw">grid.arrange</span>(p_linear,p_quad, p_cubic, <span class="dt">nrow =</span> <span class="dv">1</span>) </span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-44-1.png" width="100%" /></p>
</div>
<div id="b-splines" class="section level3" number="1.3.4">
<h3><span class="header-section-number">1.3.4</span> B-Splines</h3>
<p><span class="math display">\[T_i \sim \mathrm{Normal}(\mu_i, \sigma) \\
\ \ \ \mu_i = \alpha + \sum_{k=1}^{K} W_{k} B_{k,i} \\
\alpha \sim \mathrm{Normal(6,10)} \\
W_j \sim \mathrm{Normal(0, 1)} \\
\sigma \sim \mathrm{Exponential(1)}\]</span></p>
<p>Seems daunting. How to model this?</p>
<p>First, let’s prepare the data.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="index.html#cb51-1" aria-hidden="true"></a><span class="kw">data</span>(cherry_blossoms)</span>
<span id="cb51-2"><a href="index.html#cb51-2" aria-hidden="true"></a>d &lt;-<span class="st"> </span>cherry_blossoms </span></code></pre></div>
<p>precis</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="index.html#cb52-1" aria-hidden="true"></a><span class="kw">precis</span>(d)</span></code></pre></div>
<pre><code>##                   mean          sd      5.5%      94.5%       histogram
## year       1408.000000 350.8845964 867.77000 1948.23000   ▇▇▇▇▇▇▇▇▇▇▇▇▁
## doy         104.540508   6.4070362  94.43000  115.00000        ▁▂▅▇▇▃▁▁
## temp          6.141886   0.6636479   5.15000    7.29470        ▁▃▅▇▃▂▁▁
## temp_upper    7.185151   0.9929206   5.89765    8.90235 ▁▂▅▇▇▅▂▂▁▁▁▁▁▁▁
## temp_lower    5.098941   0.8503496   3.78765    6.37000 ▁▁▁▁▁▁▁▃▅▇▃▂▁▁▁</code></pre>
<p>We’ll use the complete cases. Not missing ones</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="index.html#cb54-1" aria-hidden="true"></a>d2 &lt;-<span class="st"> </span>d[ <span class="kw">complete.cases</span>(d<span class="op">$</span>temp) , ] </span></code></pre></div>
<p>Here comes the magic part</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="index.html#cb55-1" aria-hidden="true"></a><span class="co"># num knots</span></span>
<span id="cb55-2"><a href="index.html#cb55-2" aria-hidden="true"></a>num_knots &lt;-<span class="st"> </span><span class="dv">15</span></span>
<span id="cb55-3"><a href="index.html#cb55-3" aria-hidden="true"></a><span class="co"># list of knots</span></span>
<span id="cb55-4"><a href="index.html#cb55-4" aria-hidden="true"></a>knot_list &lt;-<span class="st"> </span><span class="kw">quantile</span>( d2<span class="op">$</span>year , <span class="dt">probs=</span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">length.out=</span>num_knots) )</span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="index.html#cb56-1" aria-hidden="true"></a><span class="co"># basis function of 3rd degree cubic spline</span></span>
<span id="cb56-2"><a href="index.html#cb56-2" aria-hidden="true"></a>B &lt;-<span class="st"> </span><span class="kw">bs</span>(d2<span class="op">$</span>year,</span>
<span id="cb56-3"><a href="index.html#cb56-3" aria-hidden="true"></a>        <span class="dt">knots=</span>knot_list[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,num_knots)] ,</span>
<span id="cb56-4"><a href="index.html#cb56-4" aria-hidden="true"></a>        <span class="dt">degree=</span><span class="dv">3</span> , <span class="dt">intercept=</span><span class="ot">TRUE</span> )</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="index.html#cb57-1" aria-hidden="true"></a><span class="kw">plot</span>(<span class="ot">NULL</span>, <span class="dt">xlim =</span> <span class="kw">range</span>(d2<span class="op">$</span>year), <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb57-2"><a href="index.html#cb57-2" aria-hidden="true"></a>     <span class="dt">xlab=</span><span class="st">&quot;year&quot;</span> , <span class="dt">ylab=</span><span class="st">&quot;basis value&quot;</span>)</span>
<span id="cb57-3"><a href="index.html#cb57-3" aria-hidden="true"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">NCOL</span>(B)) <span class="kw">lines</span>(d2<span class="op">$</span>year, B[,i])</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-50-1.png" width="100%" /></p>
<p>Well, to be honest as a beginner I don’t know how to model this using stan.</p>
<p>What can we do when such thing happens?</p>
<p>Well, stan has a very dedicated community[<a href="https://discourse.mc-stan.org" class="uri">https://discourse.mc-stan.org</a>] as far as I can see. I have never posted there, but I am regularly reading and as it seems, the people are really willing to help you with anything there. Let’s keep this in mind.</p>
<p>However, I think this should be the last resort. Why? Because people in the stan forums are doing this voluntarily. It’s not their job. If we go there and post a question which already has a solution in the internet, then, in the long term this will hurt the forum. So, let’s save this option for the rainy days and try to solve it on our own.</p>
<p>What I am proposing you here is to make use of a legendary package BRMS. As you may know BRMS allows you to model using LME4ish syntax (patsy formulas they call it I guess). While you are using that special and easy syntax, BRMS on the fly creates stan code for you internally. Yes basically it’s raw stan deep inside. It’s both cursing and a blessing. It may save you enormous amount of time by allowing you to use it’s own easy syntax. But keep in mind that this only holds true when you know what you are doing. Otherwise, it can give you the false sense of expertise. Please go ahead and play with it. You can even fit a gaussian process model as simple as this:</p>
<pre><code>         &#39;&#39;&#39;
         y ~ gp(X, params=Placeholder_arbitrary_some_number_that_you_dont_understand)
         &#39;&#39;&#39;</code></pre>
<p>Yes, you did it! But do you really understand it? If someone asks you some questions about your model, what would be your answer? Can you explain it to someone who has no statistical literacy? If no, let’s stick with our approach here. What we are going to do is making use of BRMS’ stan code creating functionality. All you have to do is giving her a formula and data. You don’t even have to fit it. However, we are going to fit it here just to check whether it matches McElreath’s solution.</p>
<p>I copy paste the code from Solomon Kurz’s edition where he walked through each example in the book using brms. work! Please check [that] too. (But make sure that you come back here. We are not done yet). I made some changes because his code doesn’t match the book version that I have. Great</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="index.html#cb59-1" aria-hidden="true"></a>d3 &lt;-</span>
<span id="cb59-2"><a href="index.html#cb59-2" aria-hidden="true"></a><span class="st">  </span>d2 <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb59-3"><a href="index.html#cb59-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">B =</span> B) </span>
<span id="cb59-4"><a href="index.html#cb59-4" aria-hidden="true"></a></span>
<span id="cb59-5"><a href="index.html#cb59-5" aria-hidden="true"></a></span>
<span id="cb59-6"><a href="index.html#cb59-6" aria-hidden="true"></a>b4<span class="fl">.8</span> &lt;-<span class="st"> </span></span>
<span id="cb59-7"><a href="index.html#cb59-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d3,</span>
<span id="cb59-8"><a href="index.html#cb59-8" aria-hidden="true"></a>      <span class="dt">family =</span> gaussian,</span>
<span id="cb59-9"><a href="index.html#cb59-9" aria-hidden="true"></a>      temp <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>B,</span>
<span id="cb59-10"><a href="index.html#cb59-10" aria-hidden="true"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">6</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb59-11"><a href="index.html#cb59-11" aria-hidden="true"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</span>
<span id="cb59-12"><a href="index.html#cb59-12" aria-hidden="true"></a>                <span class="kw">prior</span>(<span class="kw">exponential</span>(<span class="dv">1</span>), <span class="dt">class =</span> sigma)),</span>
<span id="cb59-13"><a href="index.html#cb59-13" aria-hidden="true"></a>      <span class="dt">iter =</span> <span class="dv">2000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</span>
<span id="cb59-14"><a href="index.html#cb59-14" aria-hidden="true"></a>      <span class="dt">seed =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<p>We fit the model above. let’s see if it matches the book.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="index.html#cb61-1" aria-hidden="true"></a>f &lt;-<span class="st"> </span><span class="kw">fitted</span>(b4<span class="fl">.8</span>)</span>
<span id="cb61-2"><a href="index.html#cb61-2" aria-hidden="true"></a></span>
<span id="cb61-3"><a href="index.html#cb61-3" aria-hidden="true"></a>f <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-4"><a href="index.html#cb61-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-5"><a href="index.html#cb61-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">bind_cols</span>(d2) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-6"><a href="index.html#cb61-6" aria-hidden="true"></a><span class="st">  </span></span>
<span id="cb61-7"><a href="index.html#cb61-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> temp, <span class="dt">ymin =</span> Q2<span class="fl">.5</span>, <span class="dt">ymax =</span> Q97<span class="fl">.5</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-8"><a href="index.html#cb61-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> knot_list, <span class="dt">color =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb61-9"><a href="index.html#cb61-9" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="kw">fixef</span>(b4<span class="fl">.8</span>)[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dt">color =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb61-10"><a href="index.html#cb61-10" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb61-11"><a href="index.html#cb61-11" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">fill =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.6</span>) <span class="op">+</span></span>
<span id="cb61-12"><a href="index.html#cb61-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;year&quot;</span>,</span>
<span id="cb61-13"><a href="index.html#cb61-13" aria-hidden="true"></a>       <span class="dt">y =</span> <span class="st">&quot;March Temperature&quot;</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-52-1.png" width="672" /></p>
<p>Yupp! That’s the plot I see in the book. Yes, all credit goes to BRMS. We did nothing. Our task begins here. Let’s see the Stan code that the BRMS created for us.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="index.html#cb62-1" aria-hidden="true"></a><span class="kw">stancode</span>(b4<span class="fl">.8</span>)</span></code></pre></div>
<pre><code>## // generated with brms 2.15.0
## functions {
## }
## data {
##   int&lt;lower=1&gt; N;  // total number of observations
##   vector[N] Y;  // response variable
##   int&lt;lower=1&gt; K;  // number of population-level effects
##   matrix[N, K] X;  // population-level design matrix
##   int prior_only;  // should the likelihood be ignored?
## }
## transformed data {
##   int Kc = K - 1;
##   matrix[N, Kc] Xc;  // centered version of X without an intercept
##   vector[Kc] means_X;  // column means of X before centering
##   for (i in 2:K) {
##     means_X[i - 1] = mean(X[, i]);
##     Xc[, i - 1] = X[, i] - means_X[i - 1];
##   }
## }
## parameters {
##   vector[Kc] b;  // population-level effects
##   real Intercept;  // temporary intercept for centered predictors
##   real&lt;lower=0&gt; sigma;  // residual SD
## }
## transformed parameters {
## }
## model {
##   // likelihood including constants
##   if (!prior_only) {
##     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);
##   }
##   // priors including constants
##   target += normal_lpdf(b | 0, 1);
##   target += normal_lpdf(Intercept | 6, 10);
##   target += exponential_lpdf(sigma | 1);
## }
## generated quantities {
##   // actual population-level intercept
##   real b_Intercept = Intercept - dot_product(means_X, b);
## }</code></pre>
<p>Hmm, at first glance this one looks much complicated than the models that we coded so far. Actually it’s not the case. Let’s break it down.</p>
<pre><code>            &#39;&#39;&#39;
              data {
              int&lt;lower=1&gt; N;  // total number of observations
              vector[N] Y;  // response variable
              int&lt;lower=1&gt; K;  // number of population-level effects
              matrix[N, K] X;  // population-level design matrix
              int prior_only;  // should the likelihood be ignored?
            }
            &#39;&#39;&#39;
            </code></pre>
<p>Paul Bürkner -the creater of the package- already put there explanations. Y is our temperature variable.K is number of knots in our case. X is the design matrix with N number of rows and K(knots) number of columns. The last line is telling stan program about the purpose of the task. If you are using stan model only for making prior predictive simulations, then the way is to is by tweaking that <code>int prior_only;</code> part.</p>
<pre><code>            &#39;&#39;&#39;
            }
            transformed data {
              int Kc = K - 1;
              matrix[N, Kc] Xc;  // centered version of X without an intercept
              vector[Kc] means_X;  // column means of X before centering
              for (i in 2:K) {
                means_X[i - 1] = mean(X[, i]);
                Xc[, i - 1] = X[, i] - means_X[i - 1];
              }
            &#39;&#39;&#39;
            </code></pre>
<p>As the name hints, Transformed parameters is the block where you make transformations on the data inside the stan model. Basically BRMS is centering it. We will not use this block.</p>
<pre><code>            &#39;&#39;&#39;
            parameters {
              vector[Kc] b;  // population-level effects
              real Intercept;  // temporary intercept for centered predictors
              real&lt;lower=0&gt; sigma;  // residual SD
            }
            &#39;&#39;&#39;</code></pre>
<p>The parameters block is important for us. Pay attention to types of b - <em>vector</em> - and alpha -<em>real</em>- This information is super important. Up next is, the model block</p>
<pre><code>            &#39;&#39;&#39;
            model {
              // likelihood including constants
              if (!prior_only) {
                target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);
              }
              // priors including constants
              target += normal_lpdf(b | 0, 1);
              target += normal_lpdf(Intercept | 6, 10);
              target += exponential_lpdf(sigma | 1);
            }
            &#39;&#39;&#39;</code></pre>
<p>So what does the first line imply? As we discussed above, it basically tells the stan program, in cases where the model <em>is not prior predictive simulations</em> (the int prior only part in the data block), then use this likelihood to proceed. Otherwise, ignore the likelihood and proceed. Since we are interested in the likelihood, lets see how brms constructs it for splines. <code>target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);</code> is the key element here. The rest is given us by McElreath.
When we check stan user’s guide, there it explains what this one does as:</p>
<blockquote>
<p>real normal_id_glm_lpdf(vector y | matrix x, real alpha, vector beta, real sigma)
The log normal probability density of y given location alpha+x*beta and scale sigma, where a constant &gt;intercept alpha and sigma is used for all observations. The number of rows of the independent &gt;variable matrix x needs to match the length of the dependent variable vector y and the number of &gt;columns of x needs to match the length of the weight vector beta</p>
</blockquote>
<p>Another important observation is that BRMS uses <code>target +=</code> notation in the model block. It’s basically nothing fundamentally different than what we have been doing. In plain English, target notation says, “hey, I have a target and each time I use the <code>target +=</code> notation, I am incrementally updating the information about that target.”</p>
<p>So now we know what it does internally and we can use it in our own version. But of course we have to create data for stan.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="index.html#cb68-1" aria-hidden="true"></a>spline_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">N =</span><span class="kw">NROW</span>(d3),</span>
<span id="cb68-2"><a href="index.html#cb68-2" aria-hidden="true"></a>                    <span class="dt">t =</span> d3<span class="op">$</span>temp,</span>
<span id="cb68-3"><a href="index.html#cb68-3" aria-hidden="true"></a>                    <span class="dt">knots =</span> <span class="kw">NCOL</span>(d3<span class="op">$</span>B),</span>
<span id="cb68-4"><a href="index.html#cb68-4" aria-hidden="true"></a>                    <span class="dt">X =</span> d3<span class="op">$</span>B)</span></code></pre></div>
<p>The model we learned from BRMS is</p>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; N; 
  vector[N] t;
  int&lt;lower=1&gt; knots; 
  matrix[N, knots] X; 
}
parameters {
  vector[knots] b;
  real alpha;
  real&lt;lower=0&gt; sigma;
}
transformed parameters{
  vector[N] mu = alpha + X * b;
}
model {
  target += normal_id_glm_lpdf(t | X, alpha, b, sigma);
  target += normal_lpdf(b | 0, 1);
  target += normal_lpdf(alpha | 6, 10);
  target += exponential_lpdf(sigma | 1);
}
</code></pre>
<p>Do you notice that I used transformed parameters block. I believe up to this point we have seen examples of <strong>how to reverse engineer a Golem</strong>. So, we don’t have to calculate the posterior distribution of the <span class="math inline">\(\mu\)</span> from the parameters manually. The code inside the transformed parameters block already does that for us. Then it’s going to be much easier to proceed.</p>
<p><strong>Super Important Note:</strong> Order matters here. I have written it as <code>vector[N] mu = alpha + X * b;</code>. If you write it as <code>vector[N] mu = alpha + b * X;</code>, then, stan will throw out a big chunk of error. Remember, I said pay attention to the types that we passed for the parameters. <code>*</code> operator is okay with matrix to vector multiplication. But the other way around is not permitted. Try playing with it and see the error by yourself.</p>
<p>Let’s sample from it.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="index.html#cb70-1" aria-hidden="true"></a><span class="co">#fit</span></span>
<span id="cb70-2"><a href="index.html#cb70-2" aria-hidden="true"></a>fit_experimental_spline &lt;-<span class="st"> </span><span class="kw">sampling</span>(experimental_spline.stan,</span>
<span id="cb70-3"><a href="index.html#cb70-3" aria-hidden="true"></a>                                    spline_data, </span>
<span id="cb70-4"><a href="index.html#cb70-4" aria-hidden="true"></a>                                    <span class="dt">iter=</span><span class="dv">1000</span>,</span>
<span id="cb70-5"><a href="index.html#cb70-5" aria-hidden="true"></a>                                    <span class="dt">chain=</span><span class="dv">2</span>,</span>
<span id="cb70-6"><a href="index.html#cb70-6" aria-hidden="true"></a>                                    <span class="dt">cores=</span><span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="index.html#cb73-1" aria-hidden="true"></a>post_experimental &lt;-</span>
<span id="cb73-2"><a href="index.html#cb73-2" aria-hidden="true"></a><span class="st">  </span>fit_experimental_spline<span class="op">%&gt;%</span></span>
<span id="cb73-3"><a href="index.html#cb73-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">gather_draws</span>(mu[i]) <span class="op">%&gt;%</span></span>
<span id="cb73-4"><a href="index.html#cb73-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">mean_qi</span>() <span class="op">%&gt;%</span></span>
<span id="cb73-5"><a href="index.html#cb73-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">yhat =</span>.value,</span>
<span id="cb73-6"><a href="index.html#cb73-6" aria-hidden="true"></a>         <span class="dt">lower =</span> .lower,</span>
<span id="cb73-7"><a href="index.html#cb73-7" aria-hidden="true"></a>         <span class="dt">upper =</span> .upper)</span>
<span id="cb73-8"><a href="index.html#cb73-8" aria-hidden="true"></a></span>
<span id="cb73-9"><a href="index.html#cb73-9" aria-hidden="true"></a>post_experimental<span class="op">$</span>year &lt;-<span class="st"> </span>d3<span class="op">$</span>year</span>
<span id="cb73-10"><a href="index.html#cb73-10" aria-hidden="true"></a>post_experimental<span class="op">$</span>temp &lt;-<span class="st"> </span>d3<span class="op">$</span>temp</span>
<span id="cb73-11"><a href="index.html#cb73-11" aria-hidden="true"></a></span>
<span id="cb73-12"><a href="index.html#cb73-12" aria-hidden="true"></a><span class="kw">ggplot</span>(post_experimental) <span class="op">+</span></span>
<span id="cb73-13"><a href="index.html#cb73-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y=</span> temp), <span class="dt">alpha=</span><span class="fl">0.5</span>, <span class="dt">color=</span><span class="st">&quot;dodgerblue&quot;</span>) <span class="op">+</span></span>
<span id="cb73-14"><a href="index.html#cb73-14" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y=</span> temp, <span class="dt">ymin=</span>lower, <span class="dt">ymax=</span>upper), <span class="dt">alpha=</span><span class="fl">0.6</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-57-1.png" width="100%" /></p>
<p>Wouw. We just beat the end-level boss. But if you are interested, there is another way of beating it.
Let me show you quickly</p>
<pre class="stan"><code>data {
  int&lt;lower=1&gt; N; 
  vector[N] t; 
  int&lt;lower=1&gt; knots; 
  matrix[N, knots] X; 
}
parameters {
  vector[knots] b;
  real alpha;
  real&lt;lower=0&gt; sigma;
}
transformed parameters{
  vector[N] mu = alpha + X * b;
  }
model {
  t ~ normal(mu, sigma);
  b ~ normal(0, 1);
  alpha ~ normal(6, 10);
  sigma ~ exponential(1);
}
</code></pre>
<p>We not only got rid of <code>target +=</code> notation. We used <code>t ~ normal(mu, sigma);</code>, which was originally given us by McElrath. I like this one better because it’s a direct translation of the mathematical model</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="index.html#cb75-1" aria-hidden="true"></a>fit_spline &lt;-<span class="st"> </span><span class="kw">sampling</span>(spline_model.stan, spline_data, </span>
<span id="cb75-2"><a href="index.html#cb75-2" aria-hidden="true"></a>                       <span class="dt">iter=</span><span class="dv">1000</span>,</span>
<span id="cb75-3"><a href="index.html#cb75-3" aria-hidden="true"></a>                       <span class="dt">chain=</span><span class="dv">2</span>,</span>
<span id="cb75-4"><a href="index.html#cb75-4" aria-hidden="true"></a>                       <span class="dt">cores=</span><span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="index.html#cb78-1" aria-hidden="true"></a>plot_spline &lt;-<span class="st"> </span>fit_spline<span class="op">%&gt;%</span><span class="kw">gather_draws</span>(mu[i]) <span class="op">%&gt;%</span></span>
<span id="cb78-2"><a href="index.html#cb78-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">mean_qi</span>() <span class="op">%&gt;%</span></span>
<span id="cb78-3"><a href="index.html#cb78-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">yhat =</span> .value)</span>
<span id="cb78-4"><a href="index.html#cb78-4" aria-hidden="true"></a>plot_spline<span class="op">$</span>year &lt;-<span class="st"> </span>d3<span class="op">$</span>year</span>
<span id="cb78-5"><a href="index.html#cb78-5" aria-hidden="true"></a>plot_spline<span class="op">$</span>temp &lt;-<span class="st"> </span>d3<span class="op">$</span>temp</span>
<span id="cb78-6"><a href="index.html#cb78-6" aria-hidden="true"></a><span class="kw">ggplot</span>(<span class="dt">data=</span> plot_spline) <span class="op">+</span></span>
<span id="cb78-7"><a href="index.html#cb78-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>year, <span class="dt">y=</span>temp), <span class="dt">color=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">alpha=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb78-8"><a href="index.html#cb78-8" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x=</span>year, <span class="dt">y=</span>yhat, <span class="dt">ymin=</span>.lower, <span class="dt">ymax=</span>.upper),  <span class="dt">alpha=</span><span class="fl">0.6</span>)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-60-1.png" width="100%" /></p>
<p>Yes, all the same. So we are done with the first chapter. See you in the next one.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>

<a href="the-many-variables-the-spurious-waffles.html" class="navigation navigation-next navigation-unique" aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tugberkcapraz/learning-stan-with-statistical-rethinking/edit/master/index.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/tugberkcapraz/learning-stan-with-statistical-rethinking/blob/master/index.Rmd",
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
